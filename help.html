<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>KakuDraft ヘルプ</title>
  <style>
    :root {
      --bg: #fcfaf2;
      --text: #333;
      --border: #000;
      --panel: #fff;
      --muted: #666;
      --tab: #f2efe4;
      --tab-active: #fff;
    }
    body {
      margin: 0;
      font-family: "Sawarabi Mincho", serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.8;
    }
    main {
      max-width: 980px;
      margin: 0 auto;
      padding: 20px 14px 40px;
    }
    h1 {
      margin: 0 0 8px;
      border-bottom: 2px solid var(--border);
      padding-bottom: 6px;
    }
    h2 {
      margin: 18px 0 8px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 4px;
      font-size: 20px;
    }
    h3 {
      margin: 14px 0 6px;
      font-size: 16px;
    }
    p { margin: 8px 0; }
    ul, ol { margin: 6px 0 8px 24px; }
    .lead {
      border: 1px solid var(--border);
      background: var(--panel);
      padding: 12px;
      margin-bottom: 14px;
    }
    .tabs {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .tab-btn {
      border: 1px solid var(--border);
      background: var(--tab);
      color: var(--text);
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
    }
    .tab-btn.active {
      background: var(--tab-active);
      font-weight: bold;
      border-bottom-width: 3px;
    }
    .panel {
      display: none;
      border: 1px solid var(--border);
      background: var(--panel);
      padding: 14px;
      margin-bottom: 12px;
    }
    .panel.active { display: block; }
    .note {
      border-left: 4px solid var(--border);
      padding-left: 10px;
      color: var(--muted);
      margin: 8px 0;
    }
    code {
      background: #f1eee3;
      border: 1px solid #d9d3c2;
      padding: 1px 4px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 90%;
    }
    .footer-links {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    a { color: inherit; }
  </style>
</head>
<body>
<main>
  <h1>KakuDraft ヘルプ</h1>
  <div class="lead">
    KakuDraftは、本文執筆・話ごとの管理・メモ・置換・定型挿入・履歴・ローカル保存・GitHub同期を1画面で扱える執筆アプリです。以下のタブで、使い方を目的別に確認できます。
  </div>

  <div class="tabs" role="tablist" aria-label="ヘルプタブ">
    <button class="tab-btn active" role="tab" aria-selected="true" aria-controls="tab-init" id="tab-btn-init" onclick="switchTab('init')">初期設定タブ</button>
    <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-usage" id="tab-btn-usage" onclick="switchTab('usage')">機能の使い方タブ</button>
    <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-shortcuts" id="tab-btn-shortcuts" onclick="switchTab('shortcuts')">ショートカットタブ</button>
    <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-tech" id="tab-btn-tech" onclick="switchTab('tech')">技術者向けタブ</button>
    <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-faq" id="tab-btn-faq" onclick="switchTab('faq')">よくある質問</button>
  </div>

  <section class="panel active" id="tab-init" role="tabpanel" aria-labelledby="tab-btn-init">
    <h2>初期設定タブ</h2>
    <h3>1. まず最初にやること</h3>
    <ol>
      <li>本文エリアに入力して、執筆データがローカルに保存されることを確認します。</li>
      <li>必要ならメニューの <strong>A- / A+</strong> で文字サイズを調整します。</li>
      <li>テーマ切り替えボタン（コントラストアイコン）で明暗テーマを選びます。</li>
      <li>よく使う記号は「挿入ボタン」に追加しておくと便利です。</li>
    </ol>

    <h3>2. GitHub同期を使う場合（任意）</h3>
    <ul>
      <li><code>Fine-grained PAT</code>、<code>リポジトリ名</code>、<code>端末名</code> を入力します。</li>
      <li><strong>UP</strong> でクラウドへ保存、<strong>DOWN</strong> で復元します。</li>
      <li>普段は <code>Ctrl+S</code>（Macは <code>⌘+S</code>）で保存すると、自動UP予約も動きます。</li>
    </ul>
    <p class="note">JSON仕様とGitHub同期ロジックはアプリ内部で固定設計です。通常利用では変更不要です。</p>

    <h3>3. 安全運用のコツ</h3>
    <ul>
      <li>大きな編集前後で「履歴」のスナップショットを残す。</li>
      <li>節目で「JSON出力」を取り、別媒体にもバックアップする。</li>
      <li>複数端末運用時は、DOWN前に現在データを退避する。</li>
    </ul>
  </section>

  <section class="panel" id="tab-usage" role="tabpanel" aria-labelledby="tab-btn-usage">
    <h2>機能の使い方タブ</h2>

    <h3>本文執筆と画面操作</h3>
    <ul>
      <li>本文は中央の執筆欄で入力します。</li>
      <li>メニューやメモを開いた状態で執筆欄をタップすると、サイドパネルは自動で閉じます。</li>
      <li>プレビュー（目アイコン）で現在の本文を確認できます。</li>
    </ul>

    <h3>話の管理（追加・分割・統合）</h3>
    <ul>
      <li>話の管理の <strong>add</strong> で新しい話を追加。</li>
      <li><strong>分割</strong> はカーソル位置で話を2つに分けます。</li>
      <li><strong>統合</strong> は現在話を前の話へつなげます。</li>
      <li>話タイトルの編集（編集アイコン）と話順変更（上下移動アイコン）ができます。</li>
      <li>フォルダー作成・フォルダー単位フィルター・章のフォルダー移動（フォルダーアイコン）ができます。</li>
    </ul>

    <h3>メモ機能（各話 / 全体）</h3>
    <ul>
      <li><strong>各話</strong>: 話ごとに別メモを保持。</li>
      <li><strong>全体</strong>: 作品全体で共有されるメモ。</li>
      <li>メモタブは追加・削除できます（最低1つは保持）。</li>
      <li>メモタイトル編集（✎）とタブ順の並び替え（↑↓）ができます。</li>
    </ul>

    <h3>ダウンロード機能（話を選択可能）</h3>
    <ol>
      <li>メニューの「ダウンロード」で対象の話にチェック。</li>
      <li>「すべて選択 / 解除」で一括操作。</li>
      <li>出力形式を選択:
        <ul>
          <li><strong>ZIPダウンロード</strong>: 選択話を1話1txtでZIP化。</li>
          <li><strong>結合TXTダウンロード</strong>: 1つのtxtに結合。</li>
        </ul>
      </li>
    </ol>
    <p>結合TXTでは、各話の先頭に <code>===== 話タイトル =====</code> 区切りを入れます。</p>

    <p class="note">検索&置換パネルはフッターのアイコンまたは Ctrl/⌘ + F で開けます。ショートカットの一覧は「ショートカットタブ」を参照してください。</p>
    <p class="note">外部テキストはドラッグ&ドロップで本文へ挿入できます。メモ欄には画像/音声/テキスト添付も可能です。</p>

    <h3>AIタブ（オンライン時のみ）</h3>
    <ul>
      <li>フッターのAIボタンからAIパネルを開けます。</li>
      <li>OpenRouter / Groq / Google はそれぞれ専用のAPI Keyを設定し、使うプロバイダを選んでモデル取得します。</li>
      <li>チャットと校閲（置換候補）を、現在話/フォルダー/全話スコープで実行できます。</li>
    </ul>
  </section>


  <section class="panel" id="tab-shortcuts" role="tabpanel" aria-labelledby="tab-btn-shortcuts">
    <h2>ショートカットタブ</h2>
    <ul>
      <li><code>Ctrl/⌘ + S</code>: 保存（GitHub設定時はUP予約）</li>
      <li><code>Ctrl/⌘ + M</code>: メモパネル開閉</li>
      <li><code>Ctrl/⌘ + B</code>: メニューパネル開閉</li>
      <li><code>Ctrl/⌘ + P</code>: プレビュー</li>
      <li><code>Ctrl/⌘ + E</code>: エディタ / メモのフォーカス切替</li>
      <li><code>Ctrl/⌘ + F</code>: 検索&置換パネルを開く</li>
      <li><code>Ctrl/⌘ + G</code>: 次を検索（正規表現/全話検索オプション対応）</li>
      <li><code>Ctrl/⌘ + U</code>: 本文スナップショット保存</li>
      <li><code>Ctrl/⌘ + J / K</code>: 文字サイズ - / +</li>
      <li><code>Ctrl/⌘ + Shift + ↑ / ↓</code>: 話順を上/下へ移動</li>
      <li><code>Ctrl/⌘ + H</code>: ヘルプを開く</li>
      <li>設定タブで画面消灯阻止のON/OFFが可能</li>
    </ul>
  </section>

  <section class="panel" id="tab-tech" role="tabpanel" aria-labelledby="tab-btn-tech">
    <h2>技術者向けタブ</h2>

    <h3>データ構造の概要</h3>
    <ul>
      <li>主要状態はブラウザ内の <code>IndexedDB</code>（DB: <code>kakudraft-db</code>）へ保存。</li>
      <li>章データは <code>chapters[]</code> で保持し、各話に本文・メモ・スナップショットを持ちます。</li>
      <li>GitHub連携時は <code>kakudraft_data.json</code> を対象に同期します。</li>
    </ul>

    <h3>PWA / キャッシュ</h3>
    <ul>
      <li>Service Worker（<code>sw.js</code>）でアセットをキャッシュ。</li>
      <li>更新反映時はキャッシュ名（<code>CACHE_NAME</code>）の更新が必要です。</li>
    </ul>

    <h3>ダウンロード実装メモ</h3>
    <ul>
      <li>ZIPは <code>JSZip</code> を利用してクライアント側で生成。</li>
      <li>ファイル名はOS非対応文字を置換して安全化。</li>
      <li>結合TXTは見出し区切り形式で可読性を確保。</li>
    </ul>

    <h3>保守時の注意</h3>
    <ul>
      <li>JSON仕様とGitHub同期仕様は既存互換を優先し、変更時は移行手順を必ず用意。</li>
      <li>UI追加時はメニュー内導線（ヘルプ含む）とモバイル表示を確認。</li>
      <li>統計タブはCanvasグラフ描画を使うため、描画失敗時のフォールバック表示を検討。</li>
    </ul>
  </section>

  <section class="panel" id="tab-faq" role="tabpanel" aria-labelledby="tab-btn-faq">
    <h2>よくある質問</h2>

    <h3>Q. 保存されているか不安です</h3>
    <p>A. 入力や操作ごとにローカル保存されます。さらに安全のため、定期的にJSON出力とGitHub UPを併用してください。</p>

    <h3>Q. メモを消しすぎました</h3>
    <p>A. 最低1タブは残る仕様です。本文は履歴（スナップショット）やJSONバックアップから復元できます。</p>

    <h3>Q. ダウンロードに含める話を絞りたい</h3>
    <p>A. ダウンロード欄のチェックで対象を選択してください。ZIPと結合TXTのどちらにも選択内容が反映されます。</p>

    <h3>Q. オフラインで使えますか？</h3>
    <p>A. 一度読み込んだ後はPWAキャッシュで動作しやすくなりますが、外部フォントやライブラリ取得時は初回に通信が必要です。</p>
  </section>

  <div class="footer-links">
    <a href="./index.html">← エディタに戻る</a>
  </div>
</main>

<script>
  function switchTab(tabName) {
    const tabs = ['init', 'usage', 'shortcuts', 'tech', 'faq'];
    tabs.forEach((name) => {
      const panel = document.getElementById(`tab-${name}`);
      const btn = document.getElementById(`tab-btn-${name}`);
      const active = name === tabName;
      panel.classList.toggle('active', active);
      btn.classList.toggle('active', active);
      btn.setAttribute('aria-selected', active ? 'true' : 'false');
    });
  }
</script>
</body>
</html>
