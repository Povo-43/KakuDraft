<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>KakuDraft</title>
    <link rel="icon" type="image/png" href="./icon.png">
    <link rel="apple-touch-icon" href="./icon.png">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+1p:wght@400;700&family=Noto+Sans+JP:wght@400;700&family=Noto+Serif+JP:wght@400;700&family=Sawarabi+Mincho&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./app.css">

</head>
<body data-theme="light">
<main>
    <div id="editor-container"><div id="line-highlight"></div><textarea id="editor" placeholder="執筆を開始..."></textarea></div>

    <div id="memo-panel" class="side-panel">
        <div class="scope-switch">
            <span id="scope-local" style="cursor:pointer; font-weight:bold;" onclick="switchMemoScope('local')">● 各話</span>
            <span id="scope-folder" style="cursor:pointer; opacity:0.5;" onclick="switchMemoScope('folder')">● タグ</span><span id="scope-global" style="cursor:pointer; opacity:0.5;" onclick="switchMemoScope('global')">● 全体</span>
        </div>
        <div id="memo-tabs" class="tab-bar"></div>
        <div class="memo-add-row"><input type="text" id="new-memo-name" placeholder="＋メモ名" class="input-plain"><button onclick="addMemoTab()" class="icon-btn"><span class="material-icons">add</span></button></div>
        <textarea id="memo-area" class="memo-textarea"></textarea><div class="memo-attach-wrap"><button class="sys-btn attach-btn" onclick="document.getElementById('memo-attach-input').click()"><span class="material-icons" style="font-size:16px;">attach_file</span> 添付追加</button><input id="memo-attach-input" type="file" accept="image/*,audio/*,video/*,.txt,text/plain" style="display:none" onchange="attachMemoFile(this.files[0])"><div id="memo-attachments" class="config-list"></div><div id="memo-attachment-preview" class="config-list" style="display:none;"></div></div>
    </div>

    <div id="menu-panel" class="side-panel">
        <div class="panel-content">
            <div id="stats-display" style="font-size: 13px; padding: 10px; border: 1px solid var(--border); margin-bottom: 12px; background: var(--input-bg); text-align: center;">0 文字</div>
            <div class="tab-bar" id="menu-tabs" style="margin-bottom:10px; border:1px solid var(--border);">
                <div class="tab active" data-tab="favorites" onclick="switchMenuTab('favorites')">お気に入り</div>
                <div class="tab" data-tab="chapters" onclick="switchMenuTab('chapters')">話管理</div>
                <div class="tab" data-tab="settings" onclick="switchMenuTab('settings')">設定</div>
                <div class="tab" data-tab="ai" onclick="switchMenuTab('ai')">AI</div>
                <div class="tab" data-tab="backup" onclick="switchMenuTab('backup')">バックアップ</div>
                <div class="tab" data-tab="analytics" onclick="switchMenuTab('analytics')">統計</div>
            </div>

            <div class="menu-tab-panel" id="menu-tab-favorites">
                <h4>お気に入り機能 <button onclick="toggleFavoriteEditMode()" style="font-size:11px;">編集</button></h4>
                <div id="favorite-actions" class="config-list"></div>
                <div id="favorite-edit-block" style="display:none;">
                <label style="font-size:11px; font-weight:bold;">お気に入り順序</label>
                <div id="favorite-order-list" class="config-list"></div>
                <label style="font-size:11px; font-weight:bold;">お気に入り登録</label>
                <div id="favorite-selector" class="config-list"></div>
                </div>
            </div>

            <div class="menu-tab-panel" id="menu-tab-chapters" style="display:none;">
                <h4>話の管理 <span class="material-icons" style="cursor:pointer;" onclick="addChapter()">add</span></h4>
                <div class="config-input-group"><input id="new-folder-name" placeholder="新規タグ"><button onclick="addFolder()" style="border:1px solid var(--border);">+</button></div>
                <div class="config-input-group"><select id="folder-filter" onchange="changeFolderFilter(this.value)" style="flex:1; border:1px solid var(--border); background:var(--input-bg); color:var(--text);"></select><button onclick="renameCurrentFolder()" style="border:1px solid var(--border);">タグ名変更</button></div>
                <div id="chapter-list" class="chapter-list"></div>
                <div style="display:flex; gap:5px; margin-bottom:10px;"><button class="sys-btn" onclick="splitChapter()">分割</button><button class="sys-btn" onclick="mergeChapter()">統合</button></div>
                <h4>ダウンロード</h4>
                <button class="sys-btn" onclick="toggleSelectAllDownloadTargets()">すべて選択 / 解除</button>
                <div id="download-target-list" class="config-list"></div>
                <button class="sys-btn" onclick="downloadSelectedZip()"><span class="material-icons" style="font-size:16px;">folder_zip</span> ZIPダウンロード</button>
                <button class="sys-btn" onclick="downloadSelectedMergedTxt()"><span class="material-icons" style="font-size:16px;">description</span> 結合TXTダウンロード</button>
                <label style="font-size:11px; font-weight:bold;">履歴</label>
                <button class="sys-btn" onclick="takeBodySnapshot()">現在を保存</button>
                <div id="snapshot-list" class="config-list"></div>
            </div>

            <div class="menu-tab-panel" id="menu-tab-settings" style="display:none;">
                <h4>置換・挿入</h4>
                <label style="font-size:11px; font-weight:bold;">自動置換</label>
                <div id="replace-list" class="config-list"></div>
                <div class="config-input-group"><input type="text" id="rep-from" placeholder="前"><input type="text" id="rep-to" placeholder="後"><button onclick="addListItem('replace')" style="border:1px solid var(--border); padding:0 10px;">+</button></div>
                <label style="font-size:11px; font-weight:bold;">挿入ボタン</label>
                <div id="insert-list" class="config-list"></div>
                <div class="config-input-group"><input type="text" id="ins-label" placeholder="表示"><input type="text" id="ins-value" placeholder="内容"><button onclick="addListItem('insert')" style="border:1px solid var(--border); padding:0 10px;">+</button></div>
                <h4>表示設定</h4>
                <div style="display:flex; gap:5px;"><button class="sys-btn" onclick="toggleTheme()" style="flex:1;"><span class="material-icons">contrast</span></button><button class="sys-btn" onclick="changeFontSize(-1)" style="flex:1;">A-</button><button class="sys-btn" onclick="changeFontSize(1)" style="flex:1;">A+</button></div><label class="config-item" style="cursor:pointer;"><input type="checkbox" id="wakelock-toggle" onchange="toggleWakeLock(this.checked)"><span>画面消灯を防止</span></label>

<label id="font-online-label" style="font-size:11px; font-weight:bold;">フォント（オンライン時のみ）</label>
                <select id="font-family" class="sys-btn" onchange="changeFontFamily(this.value)"><option value="'Sawarabi Mincho', serif">Sawarabi Mincho</option><option value="'Noto Serif JP', serif">Noto Serif JP</option><option value="'Noto Sans JP', sans-serif">Noto Sans JP</option><option value="'M PLUS 1p', sans-serif">M PLUS 1p</option></select>
            </div>

            <div class="menu-tab-panel" id="menu-tab-ai" style="display:none;">
                <h4>AI設定</h4>
                <div class="config-input-group">
                    <select id="ai-provider" class="field" onchange="onAIProviderChange()">
                        <option value="openrouter">OpenRouter</option>
                        <option value="groq">Groq</option>
                        <option value="google">Google</option>
                    </select>
                </div>
                <div class="config-input-group"><input id="ai-api-key-openrouter" type="password" placeholder="OpenRouter API Key"></div>
                <div class="config-input-group"><input id="ai-api-key-groq" type="password" placeholder="Groq API Key"></div>
                <div class="config-input-group"><input id="ai-api-key-google" type="password" placeholder="Google API Key"></div>
                <div class="config-input-group"><button class="sys-btn" style="margin:0;" onclick="fetchAIModels()"><span class="material-icons">refresh</span> モデル取得</button></div>
                <div class="config-input-group"><select id="ai-model" class="field"></select></div>
                <label id="ai-free-only-row" class="config-item" style="cursor:pointer;"><input id="ai-free-only" type="checkbox"><span>無料モデルのみ（OpenRouterのみ）</span></label>
                <h4>AI使用量（取得できた分）</h4>
                <div id="ai-usage" class="config-list"></div>
            </div>

            <div class="menu-tab-panel" id="menu-tab-backup" style="display:none;">
                <h4>GitHub 同期</h4>
                <div class="config-input-group"><input type="password" id="gh-token" placeholder="Fine-grained PAT"></div>
                <div class="config-input-group"><input type="text" id="gh-repo" placeholder="リポジトリ名 or owner/repo"></div>
                <div class="config-input-group"><input type="text" id="device-name" placeholder="端末名 (例: iPhone)"></div>
                <div style="display:flex; gap:5px; margin-bottom:10px;"><button class="sys-btn" onclick="githubSync('up')"><span class="material-icons" style="font-size:16px;">cloud_upload</span> UP</button><button class="sys-btn" onclick="githubSync('down')"><span class="material-icons" style="font-size:16px;">cloud_download</span> DOWN</button></div>
                <h4>エクスポート</h4>
                <button class="sys-btn" onclick="exportFullData()"><span class="material-icons" style="font-size:16px;">download</span> JSON出力</button>
                <button class="sys-btn" onclick="document.getElementById('import-file').click()"><span class="material-icons" style="font-size:16px;">upload</span> JSON復元</button>
                <button class="sys-btn" onclick="location.href='help.html'"><span class="material-icons" style="font-size:16px;">help</span> ヘルプ</button>
                <input type="file" id="import-file" style="display:none" onchange="importFullData(this)">
            </div>

            <div class="menu-tab-panel" id="menu-tab-analytics" style="display:none;">
                <h4>執筆統計</h4>
                <canvas id="writing-graph" width="300" height="120" style="width:100%; border:1px solid var(--border); background:var(--input-bg); margin-bottom:8px;"></canvas>
                <div id="session-stats" class="config-list"></div>
                <div id="top-words" class="config-list"></div>
                <div id="other-stats" class="config-list"></div><div id="search-summary" class="config-list"></div>
            </div>
        </div>
    </div>

    <div id="ai-panel" class="side-panel">
        <div class="panel-content ai-panel-content">
            <h4>AIアシスタント <div style="display:flex; gap:6px;"><button id="ai-chat-clear-btn" class="sys-btn" style="width:auto;height:28px;margin:0;" onclick="clearAIChatHistory()"><span class="material-icons" style="font-size:16px;">delete_sweep</span> 履歴クリア</button><button class="sys-btn" style="width:auto;height:28px;margin:0;" onclick="openAISettings()"><span class="material-icons" style="font-size:16px;">settings</span> 設定へ</button></div></h4>
            <div id="ai-offline-note" class="config-item" style="display:none;">オフライン中はAI機能を利用できません。</div>
            <div id="ai-busy-note" class="config-item" style="display:none;">AI応答中です。</div>
            <div class="tab-bar ai-inner-tabs">
                <div id="ai-tab-chat" class="tab active" onclick="switchAITab('chat')">チャット</div>
                <div id="ai-tab-proofread" class="tab" onclick="switchAITab('proofread')">校閲</div>
            </div>
            <div id="ai-panel-chat" class="ai-sub-panel">
                <div id="ai-chat-log" class="config-list ai-chat-log"></div>
                <div class="ai-composer">
                    <div class="ai-chat-input-row"><textarea id="ai-prompt" placeholder="AIへの指示（質問・要約・リライト依頼など）" class="field" style="min-height:80px;"></textarea><button class="sys-btn icon-only-btn ai-send-btn" style="margin:0;" title="送信" id="ai-send-chat" onclick="sendAIChat()"><span class="material-icons">send</span></button></div>
                    <div class="config-input-group ai-scope-row" style="margin-bottom:0;"><select id="ai-scope" class="field"><option value="chapter">現在話</option><option value="folder">現在タグ</option><option value="all">全話</option></select></div>
                </div>
            </div>
            <div id="ai-panel-proofread" class="ai-sub-panel" style="display:none;">
                <div id="ai-suggestions" class="config-list" style="margin-top:8px;"></div>
                <div class="ai-composer">
                    <div class="ai-chat-input-row"><textarea id="ai-proofread-prompt" placeholder="校閲の要望（未入力なら標準ルール）" class="field" style="min-height:88px;"></textarea><button class="sys-btn icon-only-btn ai-send-btn" style="margin:0;" title="校閲実行" id="ai-send-proofread" onclick="runAIProofread()"><span class="material-icons">spellcheck</span></button></div>
                    <div class="config-input-group ai-scope-row" style="margin-bottom:0;"><select id="ai-scope-proofread" class="field" onchange="document.getElementById('ai-scope').value=this.value"><option value="chapter">現在話</option><option value="folder">現在タグ</option><option value="all">全話</option></select></div>
                </div>
            </div>
        </div>
    </div>
</main>
<div id="preview-overlay" onclick="this.style.display='none'"></div>
<div id="toast" role="status" aria-live="polite"></div>
<div id="search-panel" class="floating-panel compact-search-panel">
  <div class="search-panel-head"><strong>検索</strong><button class="icon-btn compact-icon-btn" title="閉じる" onclick="toggleSearchPanel(false, true)"><span class="material-icons">close</span></button></div>
  <div class="search-row"><span class="material-icons">search</span><input id="search-query" class="field" placeholder="検索（Enter）"></div>
  <div class="search-row"><span class="material-icons">edit</span><input id="replace-query" class="field" placeholder="置換"></div>
  <div class="search-actions compact-actions"><button class="sys-btn icon-only-btn" title="次を検索" onclick="findNext()"><span class="material-icons">south</span></button><button class="sys-btn icon-only-btn" title="置換" onclick="replaceCurrent()"><span class="material-icons">find_replace</span></button><button class="sys-btn icon-only-btn" title="すべて置換" onclick="replaceAllMatches()"><span class="material-icons">done_all</span></button><button class="sys-btn icon-only-btn" title="件数更新" onclick="collectSearchResults()"><span class="material-icons">refresh</span></button></div>
  <div class="search-options"><label><input id="search-regex" type="checkbox"> 正規</label><label><input id="search-all-chapters" type="checkbox"> 全話</label></div>
</div>
<footer><div id="quick-buttons" class="btn-group"></div><div class="btn-group"><button onclick="showPreview()"><span class="material-icons">visibility</span></button><button onclick="toggleSearchPanel()"><span class="material-icons">find_replace</span></button><button onclick="togglePanel('memo-panel')"><span class="material-icons">description</span></button><button onclick="togglePanel('ai-panel')"><span class="material-icons">smart_toy</span></button><button onclick="togglePanel('menu-panel')" style="border-right:none;"><span class="material-icons">menu</span></button></div></footer>

<div id="tag-editor-modal" class="modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;" onclick="if(event.target === this) closeTagEditor();">
    <div class="modal-content" style="background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:20px; max-width:400px; max-height:80vh; overflow:auto; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;" id="tag-editor-title">タグ編集</h3>
            <button onclick="closeTagEditor()" style="background:transparent; border:none; cursor:pointer; color:var(--text); font-size:24px; padding:0; width:30px; height:30px;"><span class="material-icons">close</span></button>
        </div>
        <div id="tag-editor-checkboxes" style="margin-bottom:15px;"></div>
        <div style="display:flex; gap:10px;">
            <button class="sys-btn" onclick="saveTagEditor()" style="flex:1;">保存</button>
            <button class="sys-btn" onclick="closeTagEditor()" style="flex:1; background:var(--input-bg); color:var(--text);">キャンセル</button>
        </div>
    </div>
</div>

<script src="./app.js" defer></script>
</body>
</html>
